<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資產編號查詢連結產生器 (資安修正版)</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.js"></script>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4 text-base md:text-lg">

    <div class="w-full max-w-lg bg-white p-6 md:p-10 rounded-xl shadow-2xl border border-gray-100">
        <h1 class="text-2xl md:text-3xl font-extrabold text-gray-800 mb-2 text-center">
            資產明細資料查詢
        </h1>
        <p class="text-center text-gray-500 mb-6">
            <b>請於方框中輸入或透過圖片條碼辨識取得資產編號</b>
        </p>

        <div class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">資產編號</label>
                <input
                    type="text"
                    id="assetId"
                    placeholder="例如：96001089-6060"
                    class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg"
                    inputmode="text"
                    autocomplete="off"
                >
                <p id="errorMsg" class="mt-2 text-sm text-red-600 hidden"></p>
            </div>

            <button
                onclick="searchAsset()"
                class="w-full py-3 px-4 rounded-lg shadow-lg text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 transition transform hover:scale-[1.01] active:scale-[0.99]"
            >
                查詢並開啟新分頁
            </button>

            <div class="pt-4 border-t border-gray-200 space-y-3">
                <h2 class="text-lg font-semibold text-gray-700">條碼辨識取得資產編號</h2>

                <label
                    class="inline-flex items-center justify-center px-4 py-2 rounded-lg shadow-sm text-sm font-medium text-white bg-gray-700 hover:bg-gray-800 cursor-pointer transition-transform hover:scale-[1.01] active:scale-[0.99]"
                >
                    從圖片上傳辨識
                    <input
                        id="fileInput"
                        type="file"
                        accept="image/*"
                        capture="environment"
                        class="hidden"
                    >
                </label>

                <p id="statusMsg" class="text-sm text-gray-600 min-h-[1.5rem]"></p>

                <img
                    id="previewImage"
                    class="mt-2 w-full max-h-60 object-contain rounded-lg border border-gray-200 hidden"
                >
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">操作說明</h2>

            <p class="text-gray-700 text-sm md:text-base leading-relaxed space-y-2">
                <span class="block font-semibold text-red-600">
                    請務必於會內網路環境中使用。
                </span>
                <span class="block">
                    此工具會將您輸入的資產編號，組成完整的連結後，自動在新的瀏覽器分頁中開啟。
                </span>
            </p>
        </div>
    </div>

<script>
    const BASE_URL = "https://assetsweb.iii.org.tw/Assets/Common/Ast_Detail.aspx?id=";

    const inputField   = document.getElementById('assetId');
    const errorMsg     = document.getElementById('errorMsg');
    const statusMsg    = document.getElementById('statusMsg');
    const fileInput    = document.getElementById('fileInput');
    const previewImage = document.getElementById('previewImage');

    function searchAsset() {
        const assetId = inputField.value.trim();

        // [資安修正 Point 3] 輸入驗證
        // 使用正規表達式白名單：僅允許英文字母(A-Z, a-z)、數字(0-9)及連字號(-)
        const validationRegex = /^[A-Za-z0-9-]+$/;

        if (!assetId) {
            showError("資產編號不能為空。");
            return;
        }

        if (!validationRegex.test(assetId)) {
            showError("格式錯誤：資產編號僅允許英數字與連字號 (-)。");
            return;
        }

        // 驗證通過，隱藏錯誤訊息
        errorMsg.classList.add("hidden");

        // [資安修正 Point 1] 修復 Reverse Tabnabbing
        // 開啟新視窗
        const newWindow = window.open(BASE_URL + encodeURIComponent(assetId), "_blank");
        
        // 立即切斷 opener 連結，防止新頁面存取此頁面的 window 物件
        if (newWindow) {
            newWindow.opener = null;
        }
    }

    function showError(msg) {
        errorMsg.textContent = msg;
        errorMsg.classList.remove("hidden");
    }

    function insertDashBeforeLast4(code) {
        if (!code || code.length <= 4) return code;
        return code.slice(0, code.length - 4) + "-" + code.slice(code.length - 4);
    }

    function setStatus(msg) {
        statusMsg.textContent = msg ?? "";
    }

    fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const dataUrl = e.target.result;
            previewImage.src = dataUrl;
            previewImage.classList.remove("hidden");
            decodeBarcode(dataUrl);
        };
        reader.readAsDataURL(file);
    });

    function decodeBarcode(imageData) {
        setStatus("圖片辨識中…");
        errorMsg.classList.add("hidden"); // 重新辨識時清除舊錯誤

        Quagga.decodeSingle(
            {
                src: imageData,
                numOfWorkers: 0,
                inputStream: { size: 800 },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader"
                    ]
                }
            },
            (result) => {
                if (result && result.codeResult) {
                    const raw = result.codeResult.code;
                    const formatted = insertDashBeforeLast4(raw);

                    inputField.value = formatted;
                    setStatus(`辨識成功：${raw} → ${formatted}`);
                    
                    // 辨識成功後，可以自動隱藏之前的格式錯誤訊息
                    errorMsg.classList.add("hidden");
                } else {
                    setStatus("無法辨識條碼，請確認圖片清晰。");
                }
            }
        );
    }
</script>

</body>
</html>
